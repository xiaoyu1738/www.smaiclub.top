<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SMAI CLUB | 购买会员</title>
    <!-- 引入 Auth 脚本 -->
    <script src="https://login.smaiclub.top/common-auth.js"></script>

    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=SF+Pro+Display:wght@300;400;500;600;700&display=swap">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <style>
        :root {
            --primary-color: #000000;
            --secondary-color: #1d1d1f;
            --accent-color: #0071e3;
            --text-light: #f5f5f7;
            --text-dark: #1d1d1f;
            --text-gray: #86868b;
            --bg-gray: #f5f5f7;
            --gradient-1: linear-gradient(45deg, #ff4d4d 0%, #f9cb28 100%);
            --gradient-2: linear-gradient(45deg, #f72585 0%, #7209b7 50%, #3a0ca3 100%);
            --gradient-3: linear-gradient(45deg, #00b4d8 0%, #0096c7 50%, #0077b6 100%);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'SF Pro Display', -apple-system, BlinkMacSystemFont, sans-serif;
            background-color: #fbfbfd;
            color: var(--text-dark);
            overflow-x: hidden;
            line-height: 1.5;
            -webkit-font-smoothing: antialiased;
        }

        /* 复用 www.smaiclub.top 的导航栏样式 */
        .navbar {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0 22px;
            background-color: rgba(0, 0, 0, 0.8);
            backdrop-filter: saturate(180%) blur(20px);
            position: fixed;
            width: 100%;
            z-index: 1000;
            height: 60px;
        }

        .logo {
            font-size: 24px;
            font-weight: 600;
            color: var(--text-light);
            text-decoration: none;
        }

        .nav-links {
            display: flex;
            list-style: none;
            align-items: center;
            height: 100%;
        }

        .nav-links li {
            margin: 0 15px;
        }

        .nav-links a {
            color: var(--text-light);
            text-decoration: none;
            font-weight: 400;
            font-size: 14px;
            transition: all 0.3s ease;
            opacity: 0.9;
        }
        .nav-links a:hover {
            opacity: 1;
        }

        /* 页面内容 */
        .page-container {
            max-width: 1000px;
            margin: 0 auto;
            padding: 100px 20px 40px;
        }

        .section-header {
            text-align: center;
            margin-bottom: 50px;
        }

        .section-header h1 {
            font-size: 48px;
            font-weight: 700;
            margin-bottom: 10px;
        }

        .section-header p {
            font-size: 21px;
            color: var(--text-gray);
        }

        /* 步骤条 */
        .steps {
            display: flex;
            justify-content: center;
            margin-bottom: 40px;
        }

        .step {
            display: flex;
            align-items: center;
            opacity: 0.5;
            transition: opacity 0.3s;
        }
        .step.active {
            opacity: 1;
            font-weight: 600;
        }
        .step-number {
            width: 28px;
            height: 28px;
            background: var(--text-dark);
            color: white;
            border-radius: 50%;
            display: flex;
            justify-content: center;
            align-items: center;
            margin-right: 8px;
            font-size: 14px;
        }
        .step-divider {
            width: 60px;
            height: 2px;
            background: #ddd;
            margin: 0 15px;
        }

        /* 会员卡选择 */
        .tier-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-bottom: 40px;
        }

        .tier-card {
            background: white;
            border-radius: 18px;
            padding: 30px;
            border: 2px solid transparent;
            box-shadow: 0 4px 20px rgba(0,0,0,0.05);
            cursor: pointer;
            transition: all 0.2s;
            position: relative;
        }

        .tier-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
        }

        .tier-card.selected {
            border-color: var(--accent-color);
            background: #f0f7ff;
        }

        .tier-card.selected::after {
            content: '✓';
            position: absolute;
            top: 20px;
            right: 20px;
            color: var(--accent-color);
            font-size: 24px;
            font-weight: bold;
        }

        .tier-name {
            font-size: 24px;
            font-weight: 600;
            margin-bottom: 10px;
        }

        .tier-price {
            font-size: 32px;
            font-weight: 700;
            margin-bottom: 15px;
            color: var(--text-dark);
        }

        .tier-price span {
            font-size: 16px;
            font-weight: 400;
            color: var(--text-gray);
        }

        /* 表单区域 */
        .form-container {
            background: white;
            border-radius: 18px;
            padding: 40px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.05);
            display: none; /* 默认隐藏，选完套餐后显示 */
        }

        .form-container.active {
            display: block;
            animation: fadeIn 0.5s ease;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .form-section-title {
            font-size: 21px;
            font-weight: 600;
            margin-bottom: 25px;
            border-bottom: 1px solid #eee;
            padding-bottom: 15px;
        }

        .form-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
        }
        .full-width { grid-column: span 2; }

        .form-group {
            margin-bottom: 15px;
            position: relative;
        }

        label {
            display: block;
            margin-bottom: 8px;
            font-size: 14px;
            color: var(--text-gray);
            font-weight: 500;
        }

        input, select {
            width: 100%;
            padding: 12px;
            border: 1px solid #d2d2d7;
            border-radius: 10px;
            font-size: 16px;
            transition: border-color 0.2s;
            outline: none;
        }

        input:focus, select:focus {
            border-color: var(--accent-color);
        }

        input.invalid {
            border-color: #ff453a;
            background: #fff2f2;
        }

        .error-msg {
            color: #ff453a;
            font-size: 12px;
            margin-top: 5px;
            display: none;
        }

        /* 支付方式 */
        .payment-methods {
            display: flex;
            gap: 15px;
            margin-top: 20px;
        }

        .payment-method {
            flex: 1;
            border: 1px solid #d2d2d7;
            border-radius: 10px;
            padding: 15px;
            text-align: center;
            cursor: pointer;
            transition: all 0.2s;
        }

        .payment-method.selected {
            border-color: var(--accent-color);
            background: #f0f7ff;
            color: var(--accent-color);
            font-weight: 600;
        }

        .submit-btn {
            width: 100%;
            background: var(--accent-color);
            color: white;
            border: none;
            border-radius: 12px;
            padding: 18px;
            font-size: 18px;
            font-weight: 600;
            cursor: pointer;
            margin-top: 30px;
            transition: background 0.3s;
        }

        .submit-btn:hover {
            background: #0077ed;
        }

        .submit-btn:disabled {
            background: #ccc;
            cursor: not-allowed;
        }

        /* 模态框通用样式 */
        .modal-overlay {
            position: fixed;
            top: 0; left: 0;
            width: 100%; height: 100%;
            background: rgba(0,0,0,0.5);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 2000;
            backdrop-filter: blur(5px);
        }

        .modal {
            background: white;
            width: 90%;
            max-width: 450px;
            border-radius: 20px;
            padding: 40px;
            text-align: center;
            box-shadow: 0 20px 40px rgba(0,0,0,0.2);
            animation: popIn 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            position: relative;
        }

        .modal-close {
            position: absolute;
            top: 15px;
            right: 15px;
            color: #aaa;
            cursor: pointer;
            font-size: 20px;
        }

        @keyframes popIn {
            from { opacity: 0; transform: scale(0.9); }
            to { opacity: 1; transform: scale(1); }
        }

        .success-icon { font-size: 60px; color: #34c759; margin-bottom: 20px; }
        .error-icon { font-size: 60px; color: #ff453a; margin-bottom: 20px; }
        .info-icon { font-size: 60px; color: #0071e3; margin-bottom: 20px; }

        .key-display {
            background: #f5f5f7;
            padding: 15px;
            border-radius: 10px;
            font-family: monospace;
            font-size: 18px;
            margin: 20px 0;
            border: 1px dashed #c7c7cc;
            word-break: break-all;
            user-select: text;
        }

        .warning-text {
            color: #ff3b30;
            font-size: 13px;
            margin-top: 10px;
            font-weight: 500;
        }

        .confirm-btn {
            background: #34c759;
            color: white;
            border: none;
            padding: 12px 30px;
            border-radius: 99px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            margin-top: 20px;
            width: 100%;
        }

        .modal-btn-group {
            display: flex;
            gap: 10px;
            margin-top: 20px;
        }

        .modal-btn {
            flex: 1;
            padding: 12px;
            border-radius: 12px;
            font-weight: 600;
            cursor: pointer;
            border: none;
        }
        .btn-cancel { background: #f5f5f7; color: var(--text-dark); }
        .btn-confirm { background: #0071e3; color: white; }
    </style>
</head>
<body>

<nav class="navbar">
    <a href="https://www.smaiclub.top" class="logo">SMAI CLUB</a>
    <ul class="nav-links">
        <li><a href="https://www.smaiclub.top">首页</a></li>
        <li><a href="https://news.smaiclub.top">新闻</a></li>
        <li><a href="https://hall.smaiclub.top">展览馆</a></li>
    </ul>
</nav>

<div class="page-container">
    <div class="section-header">
        <h1>加入 SMAI CLUB</h1>
        <p>开启您的精英生活方式</p>
    </div>

    <div class="steps">
        <div class="step active" id="step1">
            <div class="step-number">1</div> 选择会员
        </div>
        <div class="step-divider"></div>
        <div class="step" id="step2">
            <div class="step-number">2</div> 填写信息
        </div>
        <div class="step-divider"></div>
        <div class="step" id="step3">
            <div class="step-number">3</div> 完成购买
        </div>
    </div>

    <!-- 1. 会员选择 -->
    <div class="tier-grid" id="tier-selection">
        <div class="tier-card" onclick="selectTier('vip', 5000)">
            <div class="tier-name">SMAI VIP</div>
            <div class="tier-price">$5,000<span>/年</span></div>
            <p style="color:#666; font-size:14px">入门级精英体验，享受基础全球特权。</p>
        </div>
        <div class="tier-card" onclick="selectTier('svip1', 15000)">
            <div class="tier-name">SMAI SVIP I</div>
            <div class="tier-price">$15,000<span>/年</span></div>
            <p style="color:#666; font-size:14px">进阶尊享，私人飞机与定制旅行。</p>
        </div>
        <div class="tier-card" onclick="selectTier('svip2', 50000)">
            <div class="tier-name">SMAI SVIP II</div>
            <div class="tier-price">$50,000<span>/年</span></div>
            <p style="color:#666; font-size:14px">顶级奢华，私人岛屿与全球顶级资源。</p>
        </div>
    </div>

    <!-- 2. 信息填写表单 -->
    <div class="form-container" id="info-form">
        <div class="form-section-title">个人信息</div>
        <div class="form-grid">
            <div class="form-group">
                <label>国家/地区</label>
                <input type="text" id="country" placeholder="例如：中国" required onblur="validateField('country')">
                <div class="error-msg" id="error-country"></div>
            </div>

            <div class="form-group">
                <label>姓名</label>
                <input type="text" id="name" placeholder="真实姓名" required onblur="validateField('name')">
                <div class="error-msg" id="error-name"></div>
            </div>

            <div class="form-group">
                <label>手机号</label>
                <input type="tel" id="phone" placeholder="请输入手机号" required onblur="validateField('phone')">
                <div class="error-msg" id="error-phone"></div>
            </div>

            <div class="form-group">
                <label>电子邮箱</label>
                <input type="email" id="email" placeholder="example@smaiclub.top" required onblur="validateField('email')">
                <div class="error-msg" id="error-email"></div>
            </div>

            <div class="form-group">
                <label>省份/州</label>
                <input type="text" id="region" placeholder="省份/城市" required onblur="validateField('region')">
                <div class="error-msg" id="error-region"></div>
            </div>

            <div class="form-group">
                <label>邮政编码</label>
                <input type="text" id="zip" placeholder="邮编" required onblur="validateField('zip')">
                <div class="error-msg" id="error-zip"></div>
            </div>

            <div class="form-group full-width">
                <label>详细地址</label>
                <input type="text" id="address" placeholder="街道、门牌号" required>
                <!-- Add error div for consistency/safety -->
                <div class="error-msg" id="error-address"></div>
            </div>

             <!-- 银行卡号 (仅在选择银行卡时验证) -->
             <div class="form-group full-width" id="card-group" style="display:none;">
                <label>银行卡号</label>
                <input type="text" id="card-num" placeholder="16-19位卡号" onblur="validateField('card')">
                <div class="error-msg" id="error-card"></div>
            </div>
        </div>

        <div class="form-section-title" style="margin-top: 30px;">支付方式</div>
        <div class="payment-methods">
            <div class="payment-method" onclick="selectPayment(this, 'alipay')">
                <i class="fab fa-alipay" style="color:#1677FF;font-size:24px;"></i><br>支付宝
            </div>
            <div class="payment-method" onclick="selectPayment(this, 'wechat')">
                <i class="fab fa-weixin" style="color:#09BB07;font-size:24px;"></i><br>微信支付
            </div>
            <div class="payment-method" onclick="selectPayment(this, 'card')">
                <i class="fas fa-credit-card" style="color:#f9cb28;font-size:24px;"></i><br>银行卡
            </div>
        </div>

        <button class="submit-btn" onclick="processPurchase()">确认支付 <span id="pay-amount"></span></button>
    </div>
</div>

<!-- 成功弹窗 -->
<div class="modal-overlay" id="success-modal">
    <div class="modal">
        <div class="success-icon"><i class="fas fa-check-circle"></i></div>
        <h2>购买成功！</h2>
        <p style="color:#666; margin:10px 0;">欢迎加入 SMAI CLUB。</p>

        <div style="text-align:left; margin-top:20px;">
            <p style="font-size:14px; font-weight:600;">设置会员许可证：</p>
            <p style="font-size:12px; color:#888;">这是您身份的唯一凭证。</p>
            <input type="text" id="new-license-input" placeholder="输入自定义密钥 (至少4位)" style="margin-top:10px;">
        </div>

        <button class="confirm-btn" onclick="preFinalizeLicense()">激活会员权益</button>
    </div>
</div>

<!-- 确认弹窗 -->
<div class="modal-overlay" id="confirm-modal">
    <div class="modal">
        <div class="info-icon"><i class="fas fa-question-circle"></i></div>
        <h2>确认密钥</h2>
        <p style="color:#666; margin:10px 0;">请确认您已牢记以下密钥，系统无法找回！</p>
        <div class="key-display" id="confirm-key-display"></div>

        <div class="modal-btn-group">
            <button class="modal-btn btn-cancel" onclick="closeModal('confirm-modal')">返回修改</button>
            <button class="modal-btn btn-confirm" onclick="doFinalizeLicense()">我已记下，继续</button>
        </div>
    </div>
</div>

<!-- 错误/提示弹窗 -->
<div class="modal-overlay" id="alert-modal">
    <div class="modal">
        <div class="modal-close" onclick="closeModal('alert-modal')">&times;</div>
        <div class="error-icon" id="alert-icon"><i class="fas fa-exclamation-circle"></i></div>
        <h2 id="alert-title">提示</h2>
        <p id="alert-msg" style="color:#666; margin:10px 0;">内容</p>
        <button class="confirm-btn" onclick="closeModal('alert-modal')" style="background:#0071e3;">确定</button>
    </div>
</div>

<script>
    let selectedTier = null;
    let selectedPrice = 0;
    let selectedPaymentMethod = null;

    // 工具：显示模态框
    function showModal(id) { document.getElementById(id).style.display = 'flex'; }
    function closeModal(id) { document.getElementById(id).style.display = 'none'; }

    function showAlert(msg, title="提示", isError=true) {
        document.getElementById('alert-title').textContent = title;
        document.getElementById('alert-msg').textContent = msg;
        document.getElementById('alert-icon').innerHTML = isError ?
            '<i class="fas fa-times-circle" style="color:#ff453a"></i>' :
            '<i class="fas fa-info-circle" style="color:#0071e3"></i>';
        showModal('alert-modal');
    }

    // 页面加载时检查用户状态，防止降级选择
    const ROLE_LEVELS = { 'user': 0, 'vip': 1, 'svip1': 2, 'svip2': 3 };
    let currentUserLevel = 0;

    document.addEventListener('DOMContentLoaded', async () => {
        try {
            const res = await fetch('https://login.smaiclub.top/api/me', { credentials: 'include' });
            const data = await res.json();
            if (data.loggedIn) {
                currentUserLevel = ROLE_LEVELS[data.role] || 0;
                updateTierAvailability();
            }
        } catch (e) {
            console.error("Failed to fetch user status", e);
        }
    });

    function updateTierAvailability() {
        const tiers = [
            { id: 'vip', level: 1, el: document.querySelectorAll('.tier-card')[0] },
            { id: 'svip1', level: 2, el: document.querySelectorAll('.tier-card')[1] },
            { id: 'svip2', level: 3, el: document.querySelectorAll('.tier-card')[2] }
        ];

        tiers.forEach(t => {
            if (t.level <= currentUserLevel) {
                t.el.style.opacity = '0.5';
                t.el.style.cursor = 'not-allowed';
                t.el.style.pointerEvents = 'none'; // 禁止点击
                // 更改显示的文字提示
                const p = t.el.querySelector('p');
                if (p) p.innerHTML += '<br><strong style="color:#ff453a">(当前已拥有同级或更高级别)</strong>';
            }
        });
    }

    function selectTier(tier, price) {
        // 二次检查（防止通过控制台调用）
        const tierLevel = ROLE_LEVELS[tier] || 0;
        if (tierLevel <= currentUserLevel) {
            return showAlert("您当前已拥有同级或更高级别的会员权益，无需重复购买或降级。", "无法购买");
        }

        selectedTier = tier;
        selectedPrice = price;

        document.querySelectorAll('.tier-card').forEach(el => el.classList.remove('selected'));
        event.currentTarget.classList.add('selected');

        const form = document.getElementById('info-form');
        form.classList.add('active');
        document.getElementById('pay-amount').textContent = `$${price.toLocaleString()}`;

        form.scrollIntoView({ behavior: 'smooth', block: 'start' });
        document.getElementById('step2').classList.add('active');
    }

    function selectPayment(el, method) {
        selectedPaymentMethod = method;
        document.querySelectorAll('.payment-method').forEach(e => e.classList.remove('selected'));
        el.classList.add('selected');

        // 如果选择银行卡，显示卡号输入框
        const cardGroup = document.getElementById('card-group');
        if (method === 'card') {
            cardGroup.style.display = 'block';
            document.getElementById('card-num').setAttribute('required', 'true');
        } else {
            cardGroup.style.display = 'none';
            document.getElementById('card-num').removeAttribute('required');
        }
    }

    // --- 验证逻辑 ---
    const VALIDATION_RULES = {
        chineseRegion: /^(中国|香港|澳门|台湾|China|Hong Kong|Macau|Taiwan)$/i,
        nameCN: /^[\u4e00-\u9fa5]+$/, // 仅中文
        nameOther: /^[a-zA-Z\s]+$/,    // 仅字母和空格
        phoneCN: /^1[3-9]\d{9}$/,      // 中国手机号 11位
        phoneGeneral: /^\d{8,15}$/,    // 其他地区简单长度
        card: /^\d{16,19}$/,           // 银行卡 16-19位
        zipCN: /^\d{6}$/,              // 中国邮编 6位
        zipGeneral: /^\d{4,10}$/,      // 其他邮编
        email: /^[^\s@]+@[^\s@]+\.[^\s@]+$/
    };

    function validateField(field) {
        let elId = field;
        if (field === 'card') elId = 'card-num';

        const el = document.getElementById(elId);
        if (!el) return true; // Safety check

        const val = el.value.trim();
        const countryVal = document.getElementById('country').value.trim();
        const errEl = document.getElementById('error-' + field);

        let isValid = true;
        let errMsg = "";

        // Determine context (is Chinese region?)
        const isChineseRegion = VALIDATION_RULES.chineseRegion.test(countryVal);

        switch(field) {
            case 'country':
                if (val.length < 2) { isValid = false; errMsg = "请输入有效的国家/地区"; }
                break;
            case 'name':
                if (isChineseRegion) {
                    if (!VALIDATION_RULES.nameCN.test(val)) { isValid = false; errMsg = "该地区姓名只能包含中文字符"; }
                } else {
                    if (!VALIDATION_RULES.nameOther.test(val)) { isValid = false; errMsg = "该地区姓名只能包含字母 (不能含数字/符号)"; }
                }
                break;
            case 'phone':
                if (isChineseRegion || val.startsWith('+86')) {
                    let cleanVal = val.replace(/^\+86/, '').trim();
                    if (!VALIDATION_RULES.phoneCN.test(cleanVal)) { isValid = false; errMsg = "请输入有效的11位手机号"; }
                } else {
                    if (!VALIDATION_RULES.phoneGeneral.test(val.replace(/[^\d]/g, ''))) { isValid = false; errMsg = "手机号格式不正确"; }
                }
                break;
            case 'email':
                if (!VALIDATION_RULES.email.test(val)) { isValid = false; errMsg = "邮箱格式不正确"; }
                break;
            case 'zip':
                if (isChineseRegion) {
                    if (!VALIDATION_RULES.zipCN.test(val)) { isValid = false; errMsg = "请输入6位邮政编码"; }
                } else {
                    if (!VALIDATION_RULES.zipGeneral.test(val)) { isValid = false; errMsg = "邮政编码格式不正确"; }
                }
                break;
            case 'card':
                if (selectedPaymentMethod === 'card') {
                    if (!VALIDATION_RULES.card.test(val.replace(/\s/g, ''))) { isValid = false; errMsg = "请输入16-19位银行卡号"; }
                }
                break;
            case 'region':
                if (val.length < 2) { isValid = false; errMsg = "请输入有效地区"; }
                break;
        }

        if (!isValid) {
            el.classList.add('invalid');
            if (errEl) {
                errEl.textContent = errMsg;
                errEl.style.display = 'block';
            }
        } else {
            el.classList.remove('invalid');
            if (errEl) errEl.style.display = 'none';
        }
        return isValid;
    }

    async function processPurchase() {
        if (!selectedTier) return showAlert("请先选择会员等级");
        if (!selectedPaymentMethod) return showAlert("请选择支付方式");

        // 全字段校验
        const fields = ['country', 'name', 'phone', 'email', 'region', 'zip', 'address'];
        if (selectedPaymentMethod === 'card') fields.push('card');

        let allValid = true;
        fields.forEach(f => {
            if (!validateField(f)) allValid = false;
        });

        if (!allValid) return showAlert("请检查表单中红色的错误项", "表单错误");

        // 检查登录状态
        const authRes = await fetch('https://login.smaiclub.top/api/me', { credentials: 'include' });
        const authData = await authRes.json();

        if (!authData.loggedIn) {
            showAlert("请先登录账号", "未登录");
            setTimeout(() => window.location.href = "https://login.smaiclub.top", 1500);
            return;
        }

        const info = {};
        fields.forEach(f => info[f] = document.getElementById(f).value.trim());

        const btn = document.querySelector('.submit-btn');
        const originalText = btn.innerHTML;
        btn.disabled = true;
        btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> 正在处理支付...';

        try {
            const res = await fetch('https://login.smaiclub.top/api/buy', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                credentials: 'include',
                body: JSON.stringify({
                    tier: selectedTier,
                    personalInfo: info
                })
            });

            if (res.ok) {
                document.getElementById('step3').classList.add('active');
                showModal('success-modal');
            } else {
                const err = await res.json();
                showAlert("购买失败: " + (err.error || "未知错误"));
                btn.disabled = false;
                btn.innerHTML = originalText;
            }
        } catch (e) {
            console.error(e);
            showAlert("网络错误，请重试");
            btn.disabled = false;
            btn.innerHTML = originalText;
        }
    }

    function preFinalizeLicense() {
        const key = document.getElementById('new-license-input').value.trim();
        if (!key || key.length < 4) {
            return showAlert("请输入至少4位的许可证密钥");
        }
        // 显示确认框
        document.getElementById('confirm-key-display').textContent = key;
        closeModal('success-modal');
        showModal('confirm-modal');
    }

    async function doFinalizeLicense() {
        const key = document.getElementById('confirm-key-display').textContent;

        try {
            const res = await fetch('https://login.smaiclub.top/api/set-license', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                credentials: 'include',
                body: JSON.stringify({ licenseKey: key })
            });

            if (res.ok) {
                showAlert("激活成功！即将跳转回首页...", "成功", false);
                setTimeout(() => window.location.href = "https://www.smaiclub.top", 1500);
            } else {
                showAlert("设置失败，请重试");
                closeModal('confirm-modal');
                showModal('success-modal'); // 返回上一步
            }
        } catch (e) {
            showAlert("网络错误");
        }
    }
</script>

</body>
</html>